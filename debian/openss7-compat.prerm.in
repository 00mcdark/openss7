#!/bin/bash
# @configure_input@
# =============================================================================
# 
# @(#) $RCSfile: openss7-compat.prerm.in,v $ $Name:  $($Revision: 1.1.2.1 $) $Date: 2011-05-10 13:45:28 $
#
# -----------------------------------------------------------------------------
#
# Copyright (c) 2008-2011  Monavacon Limited <http://www.monavacon.com/>
# Copyright (c) 2001-2008  OpenSS7 Corporation <http://www.openss7.com/>
# Copyright (c) 1997-2001  Brian F. G. Bidulock <bidulock@openss7.org>
#
# All Rights Reserved.
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU Affero General Public License as published by the Free
# Software Foundation; version 3 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more
# details.
#
# You should have received a copy of the GNU Affero General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>, or write to
# the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
# -----------------------------------------------------------------------------
#
# U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software on
# behalf of the U.S. Government ("Government"), the following provisions apply
# to you.  If the Software is supplied by the Department of Defense ("DoD"), it
# is classified as "Commercial Computer Software" under paragraph 252.227-7014
# of the DoD Supplement to the Federal Acquisition Regulations ("DFARS") (or any
# successor regulations) and the Government is acquiring only the license rights
# granted herein (the license rights customarily provided to non-Government
# users).  If the Software is supplied to any unit or agency of the Government
# other than DoD, it is classified as "Restricted Computer Software" and the
# Government's rights in the Software are defined in paragraph 52.227-19 of the
# Federal Acquisition Regulations ("FAR") (or any successor regulations) or, in
# the cases of NASA, in paragraph 18.52.227-86 of the NASA Supplement to the FAR
# (or any successor regulations).
#
# -----------------------------------------------------------------------------
#
# Commercial licensing and support of this software is available from OpenSS7
# Corporation at a fee.  See http://www.openss7.com/
#
# -----------------------------------------------------------------------------
#
# Last Modified $Date: 2011-05-10 13:45:28 $ by $Author: brian $
#
# =============================================================================
subpkg=compat
@openss7_header@
datarootdir=@datarootdir@
# -----------------------------------------------------------------------------
# Auxiliary functions:
# -----------------------------------------------------------------------------
#
prerm_snmpdlmod_move () {
    local f d="@snmpconfdir@/snmp.d" found=no
    [ -d $d ] || return 0
    for f in "$d/*"; do
	if [ -f $f ]; then
	    case $f in
		([0-9][0-9]@PACKAGE@)
		    mv -f -- $f $f.dpkg-orig || true
		    found=yes ;;
	    esac
	fi
    done
    [ $found = yes ] || return 1
    return 0
}
#
# prerm_snmpdlmod_replace() - Error unwind from prerm requires that we undo the
#   actions of prerm which moved our snmp dlmod configuration file to
#   .dpkg-orig, rebuild the snmpd configuration and reloaded the daemon.
#   Unwinding the last two can be done by prerm_snmpdlmod_rebuild(); however,
#   the first must be undone here.
#
prerm_snmpdlmod_replace () {
    local f d="@snmpconfdir@/snmp.d" found=no
    [ -d $d ] || return 0
    for f in "$d/*"; do
	if [ -f $f ]; then
	    case $f in
		([0-9][0-9]@PACKAGE@.dpkg-orig)
		    mv -f -- $f `echo "$f" | sed -e 's,\.dpkg-orig$,,'` || true
		    found=yes ;;
	    esac
	fi
    done
    [ $found = yes ] || return 1
    return 0
}
#
# prerm_snmpdlmod_rebuild () - When being removed altogether, the snmp daemon is
#   either running or not.  If it is running, the snmpd dlmods are already
#   loaded and the configuration file will not be further consulted by the
#   daemon.  Therefore, remove the configuration now.  Other libraries necessary
#   for use of the dlmods are being removed also, so signal the snmp daemon to
#   reload or restart.
#
prerm_snmpdlmod_rebuild () { :
    snmp_dir="@snmpconfdir@"
    conf_fil="@snmpconfdir@/snmpd.local.conf"
    conf_dir="@snmpconfdir@/snmp.d"
    conf_lcl="@snmpconfdir@/snmp.d/00local"
    [ -d $conf_dir ] || return 0
    can_overwrite_local=no
    if [ -e $conf_fil ]; then
	if grep '^# Generated from snmp.d' $conf_fil >/dev/null 2>&1; then
	    can_overwrite_local=yes
	fi
    fi
    [ $can_overwrite_local = yes ] || return 0
    conf_tmp="${tmppath:-'/var/tmp'}/`basename $conf_fil`.tmp.$$"
    (
	echo '# Generated from snmp.d by @PACKAGE_LCNAME@ '`date -uI`
	echo '# DO NOT EDIT THIS FILE: ALL EDITS WILL BE LOST!'
	echo '# EDIT THE FILES IN THE snmp.d DIRECTORY INSTEAD.'
	files="$conf_dir/*"
	for f in $files; do
	    if [ -f $f -a $f = "$conf_lcl" ]; then
		case $f in
		    (*.dpkg-save|*.dpkg-new|*.dpkg-orig) ;;
		    (*)
			echo '# Generated from snmp.d/'`basename $f`
			echo '# DO NOT EDIT THIS FILE: ALL EDITS WILL BE LOST!'
			echo '# EDIT THE FILE IN snmp.d/'`basename $f`' INSTEAD.'
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$$/d' $f ;;
		esac
	    fi
	done
	for f in $files ; do
	    if [ -f $f -a $f != "$conf_lcl" ]; then
		case $f in
		    (*.dpkg-save|*.dpkg-new|*.dpkg-orig) ;;
		    (*)
			echo '# Generated from snmp.d/'`basename $f`
			echo '# DO NOT EDIT THIS FILE: ALL EDITS WILL BE LOST!'
			echo '# EDIT THE FILE IN snmp.d/'`basename $f`' INSTEAD.'
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$$/d' $f ;;
		esac
	    fi
	done
    ) >$conf_tmp
    mv -f -- $conf_tmp $conf_fil
#
#   Rather than sending the snmp daemon a HUP signal it may be a better idea to
#   inform the user that the snmp subsystem should be given a reload command.
#
    if [ -x /etc/init.d/snmpd ]; then
	/etc/init.d/snmpd reload >/dev/null 2>&1 || true
    else
	killall -HUP snmpd || true
    fi
}
#
# prerm_snmpdlmod_remove() - When removing altogether, move the snmp
#   configuration file (if any) out of the way, rebuild the snmpd configuration
#   file and signal the snmp daemon to reload.
#
prerm_snmpdlmod_remove () { :
    if prerm_snmpdlmod_move; then
	prerm_snmpdlmod_rebuild || true
    fi
}
#
# prerm_snmpdlmod_abort() - When unwinding a failed removal, move the snmp
#   configuration file (if any) back, rebuild the snmpd configuration file and
#   signal the snmp daemon to reload again.
#
prerm_snmpdlmod_abort () { :
    if prerm_snmpdlmod_replace; then
	prerm_snmpdlmod_rebuild || true
    fi
}
#
# prerm_lib_remove() - We are being removed althogether.  Maintainer script
#   created files that are not dependent upon configuration files should be
#   removed at this point.
#
prerm_lib_remove () { :
    prerm_snmpdlmod_remove
}
#
# prerm_lib_abort() - A previous invocation of prerm_lib_remove() for the older
#   package failed, so unwind the snmpdlmod prerm actions.
#
prerm_lib_abort () { :
    prerm_snmpdlmod_abort
}
# -----------------------------------------------------------------------------
# Primary functions:
# -----------------------------------------------------------------------------
# xxx-prerm remove
remove_lib_prerm () { :
    prerm_lib_remove
}
# con-prerm remove 'in-favour' package new-version
conflict_prerm () { :
    prerm_lib_remove
}
# old-prerm upgrade new-version
upgrade_prerm () { :
}
# old-prerm upgrade new-version ***FAILED***
# new-prerm failed-upgrade old-version
failed_upgrade_prerm () { :
    prerm_lib_abort
}
# dec-prerm deconfigure 'in-favour' package-being-installed version ['removing' conflicting-package version]
deconfigure_prerm () { :
    prerm_lib_remove
}
@mscript_prerm@
@mscript_debhelper@
# =============================================================================
#
# $Log: openss7-compat.prerm.in,v $
# Revision 1.1.2.1  2011-05-10 13:45:28  brian
# - weak modules workup
#
# =============================================================================
# vim: ft=sh sw=4 noet nocin nosi formatoptions+=tcqlorn
