#!/bin/bash
# =============================================================================
# 
# @(#) $RCSfile: netperf_arr,v $ $Name:  $($Revision: 1.1.2.6 $) $Date: 2006/05/23 22:43:29 $
#
# -----------------------------------------------------------------------------
#
# Copyright (c) 2001-2006  OpenSS7 Corporation <http://www.openss7.com/>
# Copyright (c) 1997-2000  Brian F. G. Bidulock <bidulock@openss7.org>
#
# All Rights Reserved.
#
# Unauthorized distribution or duplication is prohibited.
#
# This software and related documentation is protected by copyright and
# distributed under licenses restricting its use, copying, distribution and
# decompilation.  No part of this software or related documentation may be
# reproduced in any form by any means without the prior written
# authorization of the copyright holder, and licensors, if any.
#
# The recipient of this document, by its retention and use, warrants that
# the recipient will protect this information and keep it confidential, and
# will not disclose the information contained in this document without the
# written permission of its owner.
#
# The author reserves the right to revise this software and documentation
# for any reason, including but not limited to, conformity with standards
# promulgated by various agencies, utilization of advances in the state of
# the technical arts, or the reflection of changes in the design of any
# techniques, or procedures embodied, described, or referred to herein.
# The author is under no obligation to provide any feature listed herein.
#
# -----------------------------------------------------------------------------
#
# As an exception to the above, this software may be distributed under the
# GNU General Public License (GPL) Version 2, so long as the software is
# distributed with, and only used for the testing of, OpenSS7 modules,
# drivers, and libraries.
#
# -----------------------------------------------------------------------------
#
# U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software on
# behalf of the U.S. Government ("Government"), the following provisions apply
# to you.  If the Software is supplied by the Department of Defense ("DoD"),
# it is classified as "Commercial Computer Software" under paragraph
# 252.227-7014 of the DoD Supplement to the Federal Acquisition Regulations
# ("DFARS") (or any successor regulations) and the Government is acquiring
# only the license rights granted herein (the license rights customarily
# provided to non-Government users).  If the Software is supplied to any unit
# or agency of the Government other than DoD, it is classified as "Restricted
# Computer Software" and the Government's rights in the Software are defined
# in paragraph 52.227-19 of the Federal Acquisition Regulations ("FAR") (or
# any successor regulations) or, in the cases of NASA, in paragraph 18.52.227-86
# of the NASA Supplement to the FAR (or any successor regulations).
#
# -----------------------------------------------------------------------------
#
# Commercial licensing and support of this software is available from OpenSS7
# Corporation at a fee.  See http://www.openss7.com/
#
# -----------------------------------------------------------------------------
#
# Last Modified $Date: 2006/05/23 22:43:29 $ by $Author: brian $
#
# -----------------------------------------------------------------------------
#
# $Log: netperf_arr,v $
# Revision 1.1.2.6  2006/05/23 22:43:29  brian
# - updated copyright headers
#
# Revision 1.1.2.5  2006/05/23 06:57:49  brian
# - header updates
#
# Revision 1.1.2.4  2005/05/14 08:30:03  brian
# - copyright header correction
#
# Revision 1.1.2.3  2004/08/13 04:34:57  brian
# - Move device to test specific options.
#
# Revision 1.1.2.2  2004/08/12 13:55:38  brian
# - Worked up arr script.
#
# Revision 1.1.2.8  2004/08/12 01:05:54  brian
# - Added benchmark scripts and documentation.
#
# Revision 1.1.2.7  2004/08/11 19:45:30  brian
# - Add verbose and debugging capability.
#
# Revision 1.1.2.6  2004/08/11 12:08:11  brian
# - A few corrections to scripts.
#
# Revision 1.1.2.5  2004/08/11 11:27:44  brian
# - Somw tweaking.
#
# Revision 1.1.2.4  2004/08/11 09:39:48  brian
# - Tweaks
#
# Revision 1.1.2.3  2004/08/11 08:02:30  brian
# - Working up script, display correct defaults.
#
# Revision 1.1.2.2  2004/08/11 07:38:23  brian
# - Working up snapshot script
#
# =============================================================================


ECHO='echo'
SHELL='/bin/bash'
SED='sed'

# check that we have a working $ECHO
if test "X$1" = X--no-reexec ; then
# Discard the --no-reexec flag and continue
    shift
elif test "X$1" = X--fallback-echo ; then
    :
else
    exec $SHELL "$0" --no-reexec ${1+"$@"}
fi

if test "X$1" = X--fallback ; then
    shift
    cat <<EOF
$*
EOF
    exit 0
fi

program=`$ECHO "$0" | $SED -e 's%^.*/%%'`
modename="$program"

ident='$RCSfile: netperf_arr,v $ $Name:  $($Revision: 1.1.2.6 $)'

HELP="Try \`$program --help' for more information."

# Sed substitution that helps us do robust quoting.  It backslashifies
# metacharacters that are still active within double-quoted strings.
Xsed="$SED"' -e 1s/^X//'
sed_quote_subst='s/\([\\`\\"$\\\\]\)/\\\1/g'
# test EBCDIC or ASCII
case `$ECHO A | od -x` in
    *[Cc]1*) # EBCDIC based system
	SP2NL="tr '\100' '\n'"
	NL2SP="tr '\r\n' '\100\100'"
	;;
    *) # Assume ASCII based system
	SP2NL="tr '\040' '\012'"
	NL2SP="tr '\015\012' '\040\040'"
	;;
esac

# NLS nuisances
# Only set LANG and LC_ALL to C if already set.
# These must not be set unconditionally because not all systems understand
# e.g. LANG=C (notably SCO).
# We save the old values to restore during execute mode.
if test "${LC_ALL+set}" = set ; then
    save_LC_ALL="$LC_ALL" ; LC_ALL=C ; export LC_ALL
fi
if test "${LANG+set}" = set ; then
    save_LANG="$LANG" ; LANG=C ;  export LANG
fi

# Make sure IFS has a sensible default
: ${IFS=" 	"}

my_letters='abcdefghijklmnopqrstuvwxyz'
my_LETTERS='ABCDEFGHIJLKMNOPQRSTUVWXYZ'
my_Letters=$my_letters$my_LETTERS
my_numbers='0123456789'
my_alphano=$my_Letters$my_numbers
my_uppercase="$SED y%*$my_letters%P$my_LETTERS%;s%[^_$my_alphano]%_%g"
my_tokenize="$SED s%[^a-zA-Z0-9]%_%g"

# defaults

command=
debug=0
verbose=1

default_command=run

default_netperf=${NETPERF_CMD:=netperf}
default_calibrate=no
default_testtime=${NETPERF_TIME:=60}
default_hostnames=${NETPERF_HOSTS:='localhost'}
default_numprocs='1'
default_rrsizes=${NETPERF_RRS:='1,1'}
default_bufsizes=${NETPERF_SKTS:='32768'}
default_xti=no
default_sctp=no ; default_sctpdevs='/dev/sctp,/dev/sctp'
default_tcp=yes ; default_tcpdevs='/dev/tcp,/dev/tcp'
default_udp=no  ; default_udpdevs='/dev/udp,/dev/udp'
default_lla=no  ; default_lladevs='/dev/dlpi,/dev/dlpi'

default_headers='-P 1'

default_run=yes
default_debug=0
default_verbose=1

defaults='command netperf calibrate testtime hostnames numprocs rrsizes bufsizes xti sctp sctpdevs tcp tcpdevs udp udpdevs lla lladevs run debug verbose headers'

function version()
{
    if test :${show:-yes} = :no ; then
	return
    fi
    cat <<EOF
$program:
    $ident
    Copyright (c) 2001-2006  OpenSS7 Corporation.  All Rights Reserved.
    Distributed by OpenSS7 Corporation under GPL Version 2,
    incorporated here by reference.
    See \`$0 -C' for more information.
EOF
}

function usage()
{
    if test :${show:-yes} = :no ; then
	return
    fi
    cat <<EOF
Usage:
    $program [options] [HOSTNAME[ HOSTNAME]*] [CPU]
    $program { -h | --help }
    $program { -V | --version }
    $program { -C | --copying }
EOF
}

function help()
{
    if test :${show:-yes} = :no ; then
	return
    fi
    version
    usage
    cat <<EOF
Arguments:
    HOSTNAME
	name of remote host [Default: $default_hostname]
    CPU
	calibrate CPU [Default: $default_calibrate]
Options:
    -c, --calibrate
	calibrate CPU [Default: $default_calibrate]
    -t, --testtime=SECONDS
	duration of each test in seconds [Default: $default_testtime]
    -H, --hostname=HOSTNAME[:PORT]
	add a name or address to the netserver host list
    -l, --hostnames='HOSTNAME[:PORT][ HOSTNAME[:PORT]]*'
	names or addresses of netserver hosts [Default: $default_hostnames]
    -n, --numproc=NUMPROC
	add a processor number to the list
    -N, --numprocs='NUMPROC[ NUMPROC]*'
	specify the processor number list [Default: \`$default_numprocs']
    -r, --rrsize=[REQ-SIZE][,][RSP-SIZE]
	add a request/response size pair to the list
    -R, --rrsizes='[REQ-SIZE][,][RSP-SIZE][ [REQ-SIZE][,][RSP-SIZE]]*'
	specify the request/response size pair list [Default: \`$default_rrsizes']
    -b, --bufsize=[SND-SIZE][,][RCV-SIZE]
	add a buffer size to the list
    -B, --bufsizse='[SND-SIZE][,][RCV-SIZE][ [SND-SIZE][,][RCV-SIZE]]*'
	specify the buffer size list [Default: \`$default_bufsizes']
    -x, --xti
	use XTI interface instead of Sockets [Default: $default_xti]
    +sctp, +s, +S, --sctp=[DEVICE[,REMDEV]], --sctps='[DEVICE[,REMDEV][ [DEVICE[,REMDEV]]*', -sctp, -S, --nosctp
	activate (for XTI DEVICE) or suppress SCTP in test [Default: $default_sctp:$default_sctpdevs]
    +tcp, +t, +T, --tcp=[[DEVICE[,REMDEV]], --tcps='[DEVICE[,REMDEV][ [DEVICE[,REMDEV]]*', -tcp, -T, --notcp
	activate (for XTI DEVICE) or suppress TCP in test [Default: $default_tcp:$default_tcpdevs]
    +udp, +u, +U, --udp=[[DEVICE[,REMDEV]], --udps='[DEVICE[,REMDEV][ [DEVICE[,REMDEV]]*', -udp, -U, --noudp
	activate (for XTI DEVICE) or suppress UDP in test [Default: $default_udp:$default_udpdevs]
    +lla, +l, +L, --lla=[[DEVICE[,REMDEV]], --llas='[DEVICE[,REMDEV][ [DEVICE[,REMDEV]]*', -lla, -L, --nolla
	activate (for DLPI DEVICE) or suppress LLA in test [Default: $default_lla:$default_lladevs]
    -d, --devices='[DEVICE[,REMDEV][ [DEVICE[,REMDEV]]*'
	for compatibility with arr_script
    -y, --dry-run
	do not execute but verify actions [Default: run]
    -q, --quiet
	supress normal output
    -D, --debug [LEVEL]
	increase or set debugging verbosity [Default: $default_debug]
    -v, --verbose [LEVEL]
	increase or set output verbosity [Default: $default_verbose]
    -h, --help
	prints this usage information and exits
    -V, --version
	prints the version information and exits
    -C, --copying
	prints copying permissions and exits
Environment:
    NETPERF_CMD
	default netperf command [Default: $default_netperf]
    NETPERF_TIME
	default test case duration [Default: $default_testtime]
    NETPERF_HOSTS
	default netserver host list [Default: \`$default_hostnames']
    NETPERF_SKTS
	default rrsize list [Default: \`$default_bufsizes']
    NETPERF_RRS
	default rrsize list [Default: \`$default_rrsizes']
EOF
}

function copying()
{
    if test :${show:-yes} = :no ; then
	return
    fi
    cat <<EOF

$ident

Copyright (c) 2001-2006  OpenSS7 Corporation <http://www.openss7.com/>
Copyright (c) 1997-2000  Brian F. G. Bidulock <bidulock@openss7.org>
 
All Rights Reserved.

Unauthorized distribution or duplication is prohibited.

This software and related documentation is protected by copyright and distribut-
ed under licenses restricting its use,  copying, distribution and decompilation.
No part of this software or related documentation may  be reproduced in any form
by any means without the prior  written  authorization of the  copyright holder,
and licensors, if any.

The recipient of this document,  by its retention and use, warrants that the re-
cipient  will protect this  information and  keep it confidential,  and will not
disclose the information contained  in this document without the written permis-
sion of its owner.

The author reserves the right to revise  this software and documentation for any
reason,  including but not limited to, conformity with standards  promulgated by
various agencies, utilization of advances in the state of the technical arts, or
the reflection of changes  in the design of any techniques, or procedures embod-
ied, described, or  referred to herein.   The author  is under no  obligation to
provide any feature listed herein.

As an exception  to the above,  this software  may be distributed  under the GNU
General Public License (GPL) Version  2,  so long as the software is distributed
with, and only used for testing of, OpenSS7 modules, drivers and libraries.

U.S. GOVERNMENT RESTRICTED RIGHTS.  If you are licensing this Software on behalf
of the U.S. Government ("Government"), the following provisions apply to you. If
the Software is supplied by the  Department of Defense ("DoD"), it is classified
as "Commercial  Computer  Software"  under  paragraph  252.227-7014  of the  DoD
Supplement  to the  Federal Acquisition Regulations  ("DFARS") (or any successor
regulations) and the  Government  is acquiring  only the  license rights granted
herein (the license rights customarily provided to non-Government users). If the
Software is supplied to any unit or agency of the Government  other than DoD, it
is  classified as  "Restricted Computer Software" and the Government's rights in
the Software  are defined  in  paragraph 52.227-19  of the  Federal  Acquisition
Regulations ("FAR")  (or any successor regulations) or, in the cases of NASA, in
paragraph  18.52.227-86 of  the  NASA  Supplement  to the FAR (or any  successor
regulations).

Commercial  licensing  and  support of this  software is  available from OpenSS7
Corporation at a fee.  See http://www.openss7.com/

EOF
}

function option_unrec()
{
    if test ${verbose:-1} -gt 0 ; then
	opt=`$ECHO -n "X$1" | $Xsed -e 's|=.*||'`
	$ECHO "$program: syntax error -- \`$opt' unrecognized" >&2
	( usage ) >&2
    fi
    exit 2
}

function option_noarg()
{
    if test ${verbose:-1} -gt 0 ; then
	opt=`$ECHO -n "X$1" | $Xsed -e 's|=.*||'`
	$ECHO "$program: syntax error -- \`$opt' does not accept an argument" >&2
	( usage ) >&2
    fi
    exit 2
}

function option_needarg()
{
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: syntax error -- \`$1' requires an argument" >&2
	( usage ) >&2
    fi
    exit 2
}

function option_after()
{
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: syntax error -- \`$1' cannot occur after \`$2'" >&2
	( usage ) >&2
    fi
    exit 2
}

function option_with()
{
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: syntax error -- \`$1' cannot occur with \`$2'" >&2
	( usage ) >&2
    fi
    exit 2
}

function option_nonopt()
{
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: syntax error -- excess nonoption arguments \`$1'" >&2
	( usage ) >&2
    fi
    exit 2
}

# Parse our command line options once, thoroughly.
while test "$#" -gt 0 -o ":$more" != ":"
do
    if test ":$more" != ":" ; then arg="-$more" ; more= ; else arg="$1" ; shift ; fi
    if test x"$more_options" = xno ; then nonopt="$arg" ; break ; fi
    # check for attached option argument
    case $arg in
	--testtime=* | --testime=* | --testtim=* | --testim=* | --time=* | --t=* | \
	--hostnames=* | --hostname=* | --hostnam=* | --hostna=* | --hostn=* | --host=* | --hos=* | --ho=* | --h=* | \
	--numprocs=* | --numproc=* | --numpro=* | --numpr=* | --nump=* | --num=* | --nu=* | --n=* | \
	--rrsizes=* | --rrsize=* | --rrsiz=* | --rrsi=* | --rrs=* | --rr=* | --r=* | \
	--bufsizes=* | --bufsize=* | --bufsiz=* | --bufsi=* | --bufs=* | --buf=* | --bu=* | --b=* | \
	--sctps=* | --sctp=* | --sct=* | --sc=* | --s=* | \
	--tcps=* | --tcp=* | --tc=* | --t=* | \
	--udps=* | --udp=* | --ud=* | --u=* | \
	--devices=* | --device=* | --devic=* | --devi=* | --dev=* | --de=* | --d=* | \
	--debug=* | --debu=* | --deb=* | --de=* | --d=* | \
	--verbose=* | --verbos=* | --verbo=* | --verb=*)
	    optarg=`$ECHO "X$arg" | $Xsed -e 's/[-_a-zA-Z0-9]*=//'` ;;
	--*=*)
	    option_noarg $arg ;;
	-[cxSTULyqDvhVC])
	    optarg= ;;
	-[cxSTULyqDvhVC]*)
	    optarg=
	    more=`$ECHO "X$arg" | $Xsed -e 's/-[cxSTULyqDvhVC]//'`
	    eval "arg=\`$ECHO \"X$arg\" | $Xsed -e 's|$more||'\`"
	    ;;
	-[tHlnNrRbBd])
	    optarg= ;;
	-[tHlnNrRbBd]*)
	    optarg=`$ECHO "X$arg" | $Xsed -e 's/-[tHlnNrRbBd]//'` ;;
	+[STULstul])
	    optarg= ;;
	+[STULstul]*)
	    optarg=`$ECHO "X$arg" | $Xsed -e 's/+[STUstul]//'` ;;
	*)
	    optarg= ;;
    esac
    # check for optional or required option argument
    if test -n "$prev" ; then
	case $arg in
	    -* | \+*) # optional arguments not forthcoming
		case $prev in
		    # these have optional option arguments
		    debug | verbose) eval "(($prev++))" ;;
		    sctpdev | tcpdev | udpdev | lladev) ;;
		    # these have required arguments
		    hostnames | hostname | numprocs | numproc | \
		    rrsizes | rrsize | bufsizes | bufsize | \
		    sctpdevs | tcpdevs | udpdevs | lladevs | devices | \
		    testtime)
			option_needarg $prevopt ;;
		esac
		prev= ; prevopt=
		;;
	    *) # if the previous option needs an argument, assign it.
		case $prev in
		    # these are accumulative: build them up
		    hostname | numproc | rrsize | bufsize | \
		    sctpdev | tcpdev | udpdev | lladev | device)
			eval "${prev}s=\"\$${prev}s\$\{${prev}s:+ }$arg\"" ;;
		    # the rest just assign
		    *)	eval "$prev=\"\$arg\"" ;;
		esac
		prev= ; prevopt=
		continue
		;;
	esac
    fi
    # Have we seen a non-optional argument yet?
    case $arg in
	--help | --h | --\? | -h | -\?)
	    show_help=yes ; if test ":$command" = ":" ; then command=none ; fi ;;
	--version | --versio | --versi | --vers | -V)
	    show_version=yes ; if test ":$command" = ":" ; then command=none ; fi ;;
	--copying | --copyin | --copyi | --copy | --cop | --co | --c | -C)
	    show_copying=yes ; if test ":$command" = ":" ; then command=none ; fi ;;
	--verbose | --verbos | --verbo | --verb)
	    prevopt="$arg" ; prev=verbose ;;
	-v)
	    ((verbose++)) ;;
	--verbose=* | --verbos=* | --verbo=* | --verb=*)
	    verbose="$optarg" ;;
	--debug | --debu | --deb)
	    prevopt="$arg" ; prev=debug ;;
	-D)
	    $ECHO "$program: enabling shell trace mode" 1>&2 ; set -x ;;
	--debug=* | --debu=* | --deb=*)
	    debug="$optarg" ;;
	--dry-run | --dryrun | --y | -y)
	    run=no ;;
	--quiet | --silent | -q)
	    show=no ; verbose=0 ; debug=0 ;;
	--calibrate | --calibrat | --calibra | --calibr | --calib | --cali | --cal | --ca | --c | -c)
	    calibrate=yes ;;
	--testtime | --testime | --testtim | --testim | --time | --t | -t)
	    prevopt="$arg" ; prev=testtime ;;
	--testtime=* | --testime=* | --testtim=* | --testim=* | --time=* | --t=* | -t*)
	    testtime="$optarg" ;;
	--hostnames | -l)
	    prevopt="$arg" ; prev=hostnames ;;
	--hostnames=* | -l*)
	    hostnames="$optarg" ;;
	--hostname | --hostnam | --hostna | --hostn | --host | --hos | --ho | --h | -H)
	    prevopt="$arg" ; prev=hostname ;;
	--hostname=* | --hostnam=* | --hostna=* | --hostn=* | --host=* | --hos=* | --ho=* | --h=* | -H*)
	    hostnames="$hostnames${hostnames:+ }$optarg" ;;
	--numprocs | -N)
	    prevopt="$arg" ; prev=numprocs ;;
	--numprocs=* | -H*)
	    numprocs="$optarg" ;;
	--numproc | --numpro | --numpr | --nump | --num | --nu | --n | -n)
	    prevopt="$arg" ; prev=numproc ;;
	--numproc=* | --numpro=* | --numpr=* | --nump=* | --num=* | --nu=* | --n=* | -n*)
	    numprocs="$numprocs${numprocs:+ }$optarg" ;;
	--rrsizes | -R)
	    prevopt="$arg" ; prev=rrsizes ;;
	--rrsizes=* | -R*)
	    rrsizes="$optarg" ;;
	--rrsize | --rrsiz | --rrsi | --rrs | --rr | --r | -r )
	    prevopt="$arg" ; prev=rrsize ;;
	--rrsize=* | --rrsiz=* | --rrsi=* | --rrs=* | --rr=* | --r=* | -r* )
	    rrsizes="$rrsizes${rrsizes:+ }$optarg" ;;
	--bufsizes | -B)
	    prevopt="$arg" ; prev=bufsizes ;;
	--bufsizes=* | -B*)
	    bufsizes="$optarg" ;;
	--bufsize | --bufsiz | --bufsi | --bufs | --buf | --bu | --b | -b)
	    prevopt="$arg" ; prev=bufsize ;;
	--bufsize=* | --bufsiz=* | --bufsi=* | --bufs=* | --buf=* | --bu=* | --b=* | -b*)
	    bufsizes="$bufsizes${bufsizes:+ }$optarg" ;;
	--sctps | \+S)
	    sctp=yes ; prevopt="$arg" ; prev=sctpdevs ;;
	--sctps=* | \+S*)
	    sctp=yes ; sctpdevs="$optarg" ;;
	--sctp | --sct | --sc | --s | \+s)
	    sctp=yes ; prevopt="$arg" ; prev=sctpdev ;;
	--sctp=* | --sct=* | --sc=* | --s=* | \+s*)
	    sctp=yes ; sctpdevs="$sctpdevs${sctpdevs:+ }$optarg" ;;
	--tcps | \+T)
	    tcp=yes ; prevopt="$arg" ; prev=tcpdevs ;;
	--tcps=* | \+T*)
	    tcp=yes ; tcpdevs="$optarg" ;;
	--tcp | --tc | \+t)
	    tcp=yes ; prevopt="$arg" ; prev=tcpdev ;;
	--tcp=* | --tc=* | \+t*)
	    tcp=yes ; tcpdevs="$tcpdevs${tcpdevs:+ }$optarg" ;;
	--udps | \+U)
	    udp=yes ; prevopt="$arg" ; prev=udpdevs ;;
	--udps=* | \+U*)
	    udp=yes ; udpdevs="$optarg" ;;
	--udp | --ud | \+u)
	    udp=yes ; prevopt="$arg" ; prev=udpdev ;;
	--udp=* | --ud=* | \+u*)
	    udp=yes ; udpdevs="$udpdevs${udpdevs:+ }$optarg" ;;
	--llas | \+L)
	    lla=yes ; prevopt="$arg" ; prev=lladevs ;;
	--llas=* | \+L*)
	    lla=yes ; lladevs="$optarg" ;;
	--lla | --ll | --l | \+l)
	    lla=yes ; prevopt="$arg" ; prev=lladev ;;
	--lla=* | --ll=* | --l=* | \+l*)
	    lla=yes ; lladevs="$lladevs${lladevs:+ }$optarg" ;;
	--devices | -d)
	    lla=yes ; prevopt="$arg" ; prev=lladevs ;;
	--devices=* | -d*)
	    lla=yes ; lladevs="$optarg" ;;
	--device | --devic | --devi | --dev | --de | --d )
	    lla=yes ; prevopt="$arg" ; prev=lladev ;;
	--device=* | --devic=* | --devi=* | --dev=* | --de=* | --d=* )
	    lla=yes ; lladevs="$lladevs${lladevs:+ }$optarg" ;;
	--nosctps | --nosctp | --nosct | --nosc | --nos | -S)
	    sctp=no ; sctpdevs= ;;
	--notcps | --notcp | --notc | -T)
	    tcp=no ; tcpdevs= ;;
	--noudps | --noudp | --noud | -U)
	    udp=no ; udpdevs= ;;
	--nollas | --nolla | --noll | -nol | -L)
	    lla=no ; lladevs= ;;
	--xti | --xt | --x | -x)
	    xti=yes ;;
	--) # end of options
	    more_options=no ;;
	-* | \+*)
	    option_unrec $arg ;;
	*)  # permute all non-options to the end
	    nonopt="${nonopt}${nonopt:+ }$arg" ;;
    esac
done

# hit end of list wanting an argument
case $prev in
    # these have optional option arguments
    debug | verbose) eval "(($prev++))" ;;
    sctpdev | tcpdev | udpdev | lladev) ;;
    # these have required arguments
    hostnames | hostname | numprocs | numproc | \
    rrsizes | rrsize | bufsizes | bufsize | \
    sctpdevs | tcpdevs | udpdevs | lladevs | devices | \
    testtime)
	option_needarg $prevopt ;;
esac

args=($nonopt${nonopt:+ }${1+$@})

if test "$verbose" -gt 3 ; then
    $ECHO "Nonoption arguments: ${args[@]}"
fi

while test "${#args[@]}" -gt 0
do
    arg="${args[0]}" ; args=(${args[1+@]}) # shift args
    case $arg in
	CPU)
	    calibrate=yes ;;
	*)
	    hostnames="$hostnames:${hostnames:+ }$arg" ;;
    esac
done

# assign defaults to all unassigned variables
for def in $defaults ; do
    val=`eval 'echo $'"$def"`
    if test :${val:+set} != :set ; then
	eval "$def=\$default_$def"
    else
	eval "$def=\"\$val\""
    fi
done

if test ${verbose:-1} -gt 1 ; then
    headers='-P 1'
fi

# do some sanity checks on options

# at least one test must be specified
if  test :${sctp:-no} = :no -a :${tcp:-no} = :no -a :${udp:-no} = :no -a :${lla:-no} = :no ; then
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: option error - one of SCTP, TCP, UDP, LLA must be specified" >&2
	( usage ) >&2
    fi
    exit 2
fi

# number of devices should match numer of hosts
hostarray=($hostnames)
hostnum=${#hostarray[@]}
if test :${lla:-no} != :no ; then prots='lla' ; else prots= ; fi
if test :${xti:-no} != :no ; then prots="sctp tcp udp${prots:+ }$prots" ; fi
for prot in $prots ; do
    eval "${prot}array=(\$${prot}devs)"
    eval "${prot}num=\$\{#${prot}array[@]}"
    eval "num=\$${prot}num"
    if test ${hostnum:-0} -ne ${num:-0} ; then
	if test ${verbose:-1} -gt 0 ; then
	    $ECHO "$program: option error - you specified $hostnum hosts but $num $prot devices" >&2
	    ( usage ) >&2
	fi
	exit 2
    fi
done

function netperf_options()
{
    if test ${verbose:-1} -gt 3 ; then
	for arg in $defaults ; do
	    val=`eval 'echo $'"$arg"`
	    $ECHO "Option $arg is \`$val'"
	done
	$ECHO
    fi
}

function scls_find()
{
    scls=`which scls 2>/dev/null`
    pname=`$ECHO "$scls" | $SED -e 's%^.*/%%'`
    if test ":$pname" = ":scls" ; then
	return
    fi
    if test -x "$scls" ; then
	return
    fi
    # scls is not in our path, check elsewhere
    scls=`whereis scls 2>/dev/null`
    scls=`$ECHO "$scls" | $SED -e 's%^scls:[[:space:]]*%%;s%[[:space:]].*%%'`
    pname=`$ECHO "$scls" | $SED -e 's%^.*/%%'`
    if test ":$pname" = ":scls" ; then
	return
    fi
    if test -x "$scls" ; then
	return
    fi
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: warning -- cannot find scls executable" >&2
    fi
    scls=scls
}

function netperf_find()
{
    netperf=`which netperf 2>/dev/null`
    pname=`$ECHO "$netperf" | $SED -e 's%^.*/%%'`
    if test ":$pname" = ":netperf" ; then
	return
    fi
    if test -x "$netperf" ; then
	return
    fi
    # netperf is not in our path, check elsewhere
    netperf=`whereis netperf 2>/dev/null`
    netperf=`$ECHO "$netperf" | $SED -e 's%^netperf:[[:space:]]*%%;s%[[:space:]].*%%'`
    pname=`$ECHO "$netperf" | $SED -e 's%^.*/%%'`
    if test ":$pname" = ":netperf" ; then
	return
    fi
    if test -x "$netperf" ; then
	return
    fi
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$program: error -- cannot find netperf executable" >&2
    fi
    if test ":${run:-yes}" = :yes ; then
	exit 1
    fi
    netperf=netperf
}

function none_command()
{
    if test -n "$show_version$show_help$show_copying" ; then
	if test ${verbose:-1} -gt 1 ; then
	    $ECHO "Displaying information"
	fi
	if test ":$show_version" != ":" ; then
	    version
	fi
	if test ":$show_help" != ":" ; then
	    help
	fi
	if test ":$show_copying" != ":" ; then
	    copying
	fi
    fi
}

function netperf_calibrate()
{
    calibration=
    if test :${calibrate:-no} = :no ; then
	return
    fi
    if test ${verbose:-1} -gt 1 ; then
	$ECHO "Performing local  CPU calibration"
	$ECHO
	$ECHO "------------------------------------"
	$ECHO "$netperf_command ${port:+-p }$port -t LOC_CPU"
    fi
    if test :${run:-yes} != :no ; then
	loc_rate=`$netperf_command ${port:+-p }$port -t LOC_CPU`
    fi
    if test ${verbose:-1} -gt 1 ; then
	$ECHO "  Local  CPU rate = $loc_rate"
	$ECHO
	$ECHO
    fi
    if test "${loc_rate:-0}" -gt 0 ; then
	calibration="$calibration${calibration:+ }-c $loc_rate"
    fi
    if test ${verbose:-1} -gt 1 ; then
	$ECHO "Performing remote CPU calibration"
	$ECHO
	$ECHO "------------------------------------"
	$ECHO "$netperf_command ${port:+-p }$port -t REM_CPU -H $hostname"
    fi
    if test :${run:-yes} != :no ; then
	rem_rate=`$netperf_command ${port:+-p }$port -t REM_CPU -H $hostname`
    fi
    if test ${verbose:-1} -gt 1 ; then
	$ECHO "  Remote CPU rate = $rem_rate"
	$ECHO
	$ECHO
    fi
    if test "${rem_rate:-0}" -gt 0 ; then
	calibration="$calibration${calibration:+ }-C $rem_rate"
    fi
}

function scls_show()
{
    if test ${verbose:-1} -lt 1 ; then
	return
    fi
    if test :${xti:-no} = :no ; then
	return
    fi
    scls_modules="sth timod"
    if test :${device:-/dev/udp} = :/dev/udp ; then
	scls_modules="$scls_modules inet"
    fi
    if test :${device:-/dev/udp} = :/dev/udp2 ; then
	scls_modules="$scls_modules udp2"
    fi
    if test :${device:-/dev/tcp} = :/dev/tcp ; then
	scls_modules="$scls_modules inet"
    fi
    if test :${device:-/dev/tcp} = :/dev/tcp2 ; then
	scls_modules="$scls_modules tcp2"
    fi
    if test :${device:-/dev/sctp} = :/dev/sctp ; then
	scls_modules="$scls_modules sctp"
    fi
    if test :${device:-/dev/sctp} = :/dev/sctp2 ; then
	scls_modules="$scls_modules sctp2"
    fi
    if test ${verbose:-1} -gt 1 ; then
	scls_options="-b -a -r"
    else
	scls_options="-c -a -r"
    fi
    if test ${verbose:-1} -gt 1 ; then
	$ECHO "STREAMS statistics"
	$ECHO
	$ECHO "------------------------------------"
    fi
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "$scls $scls_options $scls_modules"
    fi
    if test :${run:-yes} != :no ; then
	$scls $scls_options $scls_modules
    fi
    $ECHO
}

procsarray=($numprocs)

function netperf_rr_tests()
{
    if test :${xti:-no} = :no -o :$2 = :lla ; then testcase="${1}_RR" ; else testcase="XTI_${1}_RR" ; fi
    for rrsize in $rrsizes ; do
	i=0
	while test "${i:-0}" -lt ${hostnum:-0} ; do
	    if test :${xti:-no} = :yes -o :$2 = :lla ; then
		eval "device=\"\$\{${2}array[\$i]:+ -X \$\{${2}array[\$i]}}\""
	    else
		device=
	    fi
	    host=${hostarray[$i]}
	    if ( echo "$host" | grep -q ':' 2>&1 >/dev/null ) ; then
		port=`echo "X$host" | $Xsed -e 's|.*:||'`
	    else
		port=
	    fi
	    host=`echo "X$host" | $Xsed -e 's|:.*||'`
	    j=0
	    while test "${j:-0}" -lt "${procsarray[$i]}" ; do
		if test ${verbose:-1} -gt 0 ; then
		    $ECHO "Starting $rrsize $testcase tests at `date`"
		    $ECHO
		    $ECHO "------------------------------------"
		    $ECHO "Testing with the following command line:"
		    $ECHO "$netperf ${port:+-p }$port $stats $headers -l $testtime -t $testcase -H $host $calibration -- -r $rrsize $device &"
		    $ECHO
		fi
		if test :${run:-yes} != :no ; then
		    $netperf ${port:+-p }$port $stats $headers -l $testtime -t $testcase -H $host $calibration -- -r $rrsize $device &
		fi
		scls_show
		if test ${verbose:-1} -gt 0 ; then
		    $ECHO
		    $ECHO
		fi
		((j++))
	    done
	    ((i++))
	done
    done
}

function netperf_sctp_tests()
{
    if test :${sctp:-no} != :yes ; then
	return
    fi
    netperf_rr_tests 'SCTP' 'sctp'
}

function netperf_tcp_tests()
{
    if test :${tcp:-no} != :yes ; then
	return
    fi
    netperf_rr_tests 'TCP' 'tcp'
}

function netperf_udp_tests()
{
    if test :${udp:-no} != :yes ; then
	return
    fi
    netperf_rr_tests 'UDP' 'udp'
}

function netperf_lla_tests()
{
    if test :${lla:-no} != :yes ; then
	return
    fi
    netperf_rr_tests 'HIPPI' 'lla'
}

function netperf_test()
{
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "Netperf $program script started at `date`"
	$ECHO
    fi
    netperf_calibrate
    scls_show
    netperf_sctp_tests
    netperf_tcp_tests
    netperf_udp_tests
    if test ${verbose:-1} -gt 0 ; then
	$ECHO "Tests completed at `date`"
	$ECHO
	$ECHO "If you wish to submit these results to the netperf database at"
	$ECHO "http://www.cup.hp.com/netperf/NetperfPage.html, please submit each"
	$ECHO "datapoint individually. Individual datapoints are separated by"
	$ECHO "lines of dashes."
    fi
}

function netperf_copying()
{
    if test ${verbose:-1} -gt 1 ; then
	copying
    fi
}

function run_command()
{
    netperf_copying
    netperf_options
    netperf_find
    scls_find
    if test "${verbose:-1}" -gt 1 ; then
	((verb=$verbose-1))
	verb="-v $verb"
    fi
    if test "${debug:-0}" -gt 0 ; then
	debg="-d"
    fi
    netperf_command="$netperf"
    netperf="$netperf $verb $debg"
    netperf_test
}

case "$command" in
    none)
	none_command
	;;
    run)
	run_command
	;;
    *)
	if test ${verbose:-1} -gt 0 ; then
	    ( usage ) >&2
	fi
	exit 1
	;;
esac

exit 0

# vim: ft=sh noet sw=4 nocindent
