#!/bin/sh

_install_snmpconf() {
    local snmp_fil snmp_dir snmp_lcl snmp_tmp wrote_one changed_local files f
    echo ">>> Updating /etc/snmp/snmpd.conf..." >&2
    snmp_fil=/etc/snmp/snmpd.local.conf
    snmp_dir=/etc/snmp/snmp.d
    snmp_lcl=/etc/snmp/snmp.d/00local
    snmp_tmp=/var/tmp/snmpd.local.conf.tmp.$$
    wrote_one=no
    changed_local=no
    files="$snmp_dir/*"
    if [ ! -e /etc/snmp/snmpd.conf -a -e /etc/snmpd.conf ]; then
	ln -L /etc/snmpd.conf /etc/snmp/snmpd.conf
	touch /etc/snmpd.local.conf
    fi
    if [ ! -e /etc/snmp/snmpd.local.conf -a -e /etc/snmpd.local.conf ]; then
	ln -L /etc/snmpd.local.conf $etc/snmp/snmpd.conf
    fi
    if [ -s $snmp_fil ]; then
	if ! grep '^# Generated from snmp.d' $snmp_fil >/dev/null 2>&1; then
	    cp -f -b --suffix=.pacorig -- $snmp_fil $snmp_lcl
	fi
    fi
    (   echo '# Generated from snmp.d by openss7'
	echo '# DO NOT EDIT THIS FILE: ALL EDITS WILL BE LOST!'
	echo '# EDIT THE FILES IN THE snmp.d DIRECTORY INSTEAD.'
    ) >$snmp_tmp
    for f in $files; do
	if [ -f $f -a $f = $snmp_lcl ]; then
	    case $f in
		(*.pacorig|*.pacnew) ;;
		(*) (   echo '# Generated from snmp.d/'`basename $f`
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$/d' $f
		    ) >>$snmp_tmp
		    ;;
	    esac
	fi
    done
    for f in $files ; do
	if [ -f $f -a $f != $snmp_lcl ]; then
	    case $f in
		(*.pacorig|*.pacnew) ;;
		(*) (   echo '# Generated from snmp.d/'`basename $f`
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$/d' $f
		    ) >>$snmp_tmp
		    wrote_one=yes
		    ;;
	    esac
	fi
    done
    if [ $wrote_one = yes ]; then
	if ! diff $snmp_tmp $snmp_fil >/dev/null 2>&1; then
	    cp -f -b --suffix=.pacorig -- $snmp_tmp $snmp_fil
	    changed_local=yes
	fi
    elif [ -f $snmp_lcl ]; then
	cp -f -- $snmp_lcl $snmp_fil
	rm -f -- $snmp_lcl
	changed_local=yes
    elif [ -s $snmp_fil ]; then
	cat /dev/null > $snmp_fil
	changed_local=yes
    fi
    rmdir $snmp_dir 2>/dev/null || :
    rm -f -- $snmp_tmp || :
    echo ">>> ...done." >&2
    if [ $changed_local = yes ]; then
	echo ">>> Consider restarting the SNMP daemon." >&2
    fi
}

_remove_snmpconf() {
    local snmp_fil snmp_dir snmp_lcl snmp_tmp wrote_one changed_local files f
    echo ">>> Updating /etc/snmp/snmpd.conf..." >&2
    snmp_fil=/etc/snmp/snmpd.local.conf
    snmp_dir=/etc/snmp/snmp.d
    snmp_lcl=/etc/snmp/snmp.d/00local
    snmp_tmp=/var/tmp/snmpd.local.conf.tmp.$$
    wrote_one=no
    changed_local=no
    files="$snmp_dir/*"
    if [ ! -e /etc/snmp/snmpd.conf -a -e /etc/snmpd.conf ]; then
	ln -L /etc/snmpd.conf /etc/snmp/snmpd.conf
	touch /etc/snmpd.local.conf
    fi
    if [ ! -e /etc/snmp/snmpd.local.conf -a -e /etc/snmpd.local.conf ]; then
	ln -L /etc/snmpd.local.conf /etc/snmp/snmpd.local.conf
    fi
    if [ -s $snmp_fil ]; then
	if grep '^# Generated from snmp.d' $snmp_fil >/dev/null 2>&1; then
	    if [ -d $snmp_dir ]; then
		cp -f -b --suffix=.pacorig -- $snmp_fil $snmp_lcl
	    fi
	fi
    fi
    (   echo '# Generated from snmp.d by openss7'
	echo '# DO NOT EDIT THIS FILE: ALL EDITS WILL BE LOST!'
	echo '# EDIT THE FILES IN THE snmp.d DIRECTORY INSTEAD.'
    ) >$snmp_tmp
    for f in $files; do
	if [ -f $f -a $f = $snmp_lcl ]; then
	    case $f in
		(*.pacorig|*.pacnew) ;;
		(*) (   echo '# Generated from snmp.d/'`basename $f`
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$/d' $f
		    ) >>$snmp_tmp
		    ;;
	    esac
	fi
    done
    for f in $files ; do
	if [ -f $f -a $f != $snmp_lcl ]; then
	    case $f in
		(*.pacorig|*.pacnew) ;;
		(*) (   echo '# Generated from snmp.d/'`basename $f`
			sed '/^[[:space:]]*##/d;/^[[:space:]]*$/d' $f
		    ) >>$snmp_tmp
		    wrote_one=yes
		    ;;
	    esac
	fi
    done
    if [ $wrote_one = yes ]; then
	if ! diff $snmp_tmp $snmp_fil >/dev/null 2>&1; then
	    cp -f -b --suffix=.pacorig -- $snmp_tmp $snmp_fil
	    changed_local=yes
	fi
    elif [ -f $snmp_lcl ]; then
	cp -f -- $snmp_lcl $snmp_fil
	rm -f -- $snmp_lcl
	changed_local=yes
    else
	cat /dev/null > $snmp_fil
	changed_local=yes
    fi
    rmdir $snmp_dir 2>/dev/null || :
    rm -f -- $snmp_tmp || :
    echo ">>> ...done." >&2
    if [ $changed_local = yes ]; then
	echo ">>> Consider restarting the SNMP daemon." >&2
    fi
}

case "$1" in
    (--install|"")
	_install_snmpconf || :
	;;
    (--remove)
	_remove_snmpconf || :
	;;
    (--help)
	echo -e "Usage:\n\tupdate-snmpconf {--install|--remove}"
	;;
    (*)
	echo "ERROR: Unrecognized switch $1" >&2
	;;
esac

# vim: sw=4
